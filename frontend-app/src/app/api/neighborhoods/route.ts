// src/app/api/neighborhoods/route.ts
import { NextResponse } from "next/server";
import { db } from "@db/config/configureClient";
import { sql } from "drizzle-orm";
import { violations } from "@/db/migrations/schema"; // adjust import path if needed

// Minimal but broad Baltimore neighborhood catalog (extend as desired).
// Tip: keep UPPERCASE to match the city's dropdown exactly.
const STATIC_NEIGHBORHOODS = [
  "ABELL",
  "ALLENDALE",
  "ARCADIA",
  "ARLINGTON",
  "ARMISTEAD GARDENS",
  "ASHBURTON",
  "BALTIMORE HIGHLANDS",
  "BALTIMORE-LINWOOD",
  "BARCLAY",
  "BARRE CIRCLE",
  "BAYVIEW/FIFTEENTH STREET",
  "BEECHFIELD",
  "BELAIR-EDISON",
  "BELAIR-PARKSIDE",
  "BELLONA-GITTINGS",
  "BEREA",
  "BETTER WAVERLY",
  "BEVERLY HILLS",
  "BIDDLE STREET",
  "BLYTHEWOOD",
  "BOLTON HILL",
  "BOLTON HILL EAST",
  "BOLTON HILL NORTH",
  "BOLTON HILL WEST",
  "BOOTH-BOYD",
  "BREWERS HILL",
  "BRIDGEVIEW / GREENLAWN",
  "BRIDGEVIEW/GREENLAWN",
  "BROADWAY",
  "BROADWAY EAST",
  "BROENING MANOR",
  "BROOKLYN",
  "BURLEITH-LEIGHTON",
  "BUTCHER'S HILL",
  "CALLAWAY-GARRISON",
  "CAMERON VILLAGE",
  "CANTON",
  "CANTON INDUSTRIAL AREA",
  "CARROLL PARK",
  "CARROLL-SOUTH HILTON",
  "CARROLLTON RIDGE",
  "CEDARCROFT",
  "CEDMONT",
  "CEDONIA",
  "CENTRAL FOREST PARK",
  "CENTRAL PARK HEIGHTS",
  "CHARLES NORTH",
  "CHARLES VILLAGE",
  "CHERRY HILL",
  "CHESWOLDE",
  "CHINQUAPIN PARK-BELVEDERE",
  "CHRISTOPHER",
  "CLAREMONT",
  "CLAREMONT-FREEDOM",
  "CLIFTON PARK",
  "COLDSPRING",
  "COLDSTREAM HOMESTEAD MONTEBELLO",
  "CONCERNED CITIZENS OF FOREST PARK",
  "COPPIN HEIGHTS/ASH-CO-EAST",
  "CROSS COUNTRY",
  "CROSS KEYS",
  "CURTIS BAY",
  "CURTIS BAY INDUSTRIAL",
  "CUTHBERT",
  "CYLBURN",
  "DARLEY PARK",
  "DICKEYVILLE",
  "DOLFIELD",
  "DORCHESTER",
  "DORCHESTER/GRAN-BARR",
  "DOWNTOWN",
  "DRUID HEIGHTS",
  "DRUID HILL PARK",
  "DUNBAR-BROADWAY",
  "EAST ARLINGTON",
  "EAST BALTIMORE MIDWAY",
  "EASTERWOOD",
  "EASTWOOD",
  "EDMONDSON",
  "EDMONDSON VILLAGE",
  "EDNOR GARDENS-LAKESIDE",
  "ELLWOOD PARK/MONUMENT",
  "EVERGREEN",
  "EVERGREEN LAWN",
  "FAIRFIELD",
  "FAIRFIELD AREA",
  "FAIRMONT",
  "FAIRMOUNT",
  "FALLSTAFF",
  "FEDERAL HILL",
  "FEDERAL HILL/MONTGOMERY",
  "FELLS POINT",
  "FOREST PARK",
  "FOREST PARK GOLF COURSE",
  "FOUR BY FOUR",
  "FRANKFORD",
  "FRANKLIN SQUARE",
  "FRANKLINTOWN",
  "FRANKLINTOWN ROAD",
  "GARWYN OAKS",
  "GAY STREET",
  "GLEN",
  "GLEN OAKS",
  "GLENHAM-BELFORD",
  "GOVANS COMMUNITY CIVIC INTERES",
  "GRACELAND PARK",
  "GREATER MONDAWMIN",
  "GREEKTOWN",
  "GREENMOUNT WEST",
  "GREENSPRING",
  "GROVE PARK",
  "GUILFORD",
  "GWYNNS FALLS",
  "GWYNNS FALLS/LEAKIN PARK",
  "HAMPDEN",
  "HAMPSTEAD HILL",
  "HANLON-LONGWOOD",
  "HANLON/LONGWOOD",
  "HARFORD-ECHODALE-PERRING PARKW",
  "HARFORD-ECHODALE/PERRING PARKW",
  "HARLEM PARK",
  "HARWOOD",
  "HAWKINS POINT",
  "HEATHBROOK",
  "HERITAGE CROSSING",
  "HERRING RUN PARK",
  "HIGHLANDTOWN",
  "HILLEN",
  "HILLSDALE HEIGHTS",
  "HOES HEIGHTS",
  "HOLABIRD INDUSTRIAL PARK",
  "HOLLINS MARKET",
  "HOLLINS PARK",
  "HOMELAND",
  "HOPKINS BAYVIEW",
  "HOWARD PARK",
  "HUDSON-HIGHLANDTOWN",
  "HUNTING RIDGE",
  "IDLEWOOD",
  "INNER HARBOR",
  "IRVINGTON",
  "JOHNS HOPKINS HOMEWOOD",
  "JOHNSTON SQUARE",
  "JONES FALLS AREA",
  "JONESTOWN",
  "JOSEPH LEE",
  "KENILWORTH PARK",
  "KERNEWOOD",
  "KESWICK",
  "KRESSON",
  "LAFAYETTE",
  "LAKE EVESHAM",
  "LAKE WALKER",
  "LAKELAND",
  "LANGSTON HUGHES",
  "LAURAVILLE",
  "LEVINDALE",
  "LEXINGTON",
  "LEXINGTON TERRACE",
  "LIBERTY SQUARE",
  "LITTLE ITALY",
  "LOCH RAVEN",
  "LOCUST POINT",
  "LOCUST POINT INDUSTRIAL AREA",
  "LOWER HERRING RUN PARK",
  "LOYOLA/NOTRE DAME",
  "LUCILLE PARK",
  "MADISON NORTH",
  "MADISON PARK",
  "MADISON SOUTH",
  "MADISON STREET",
  "MADISON-EASTEND",
  "MAYFIELD",
  "MAYFIELD - MONTEBELLO",
  "MCELDERRY PARK",
  "MEDFIELD",
  "MEDFORD",
  "MEDICAL INSTITUTIONS",
  "MID-GOVANS",
  "MID-TOWN BELVEDERE",
  "MIDDLE EAST",
  "MIDTOWN-EDMONDSON",
  "MILFORD MILL",
  "MILLHILL",
  "MONDAWMIN",
  "MONTEBELLO",
  "MORRELL PARK",
  "MOSHER",
  "MOUNT HOLLY",
  "MOUNT VERNON",
  "MOUNT VERNON PLACE",
  "MT WASHINGTON",
  "NEW NORTHWOOD",
  "NORTH ROLAND PARK/POPLAR HILL",
  "NORTHWOOD",
  "NOTTINGHAM",
  "OAKLEE",
  "O'DONNELL HEIGHTS",
  "OLD GOUCHER",
  "OLDTOWN",
  "ORANGEVILLE",
  "OTTERBEIN",
  "OVERLEA",
  "PANWAY/BRADDISH AVE.",
  "PATTERSON PARK",
  "PATTERSON PARK NEIGHBORHOOD",
  "PENN NORTH",
  "PENN-FALLSWAY",
  "PENROSE/FAYETTE STREET OUTR",
  "PIGTOWN/WASHINGTON VILLAGE",
  "PIMLICO GOOD NEIGHBORS",
  "PLEASANT VIEW GARDENS",
  "PULASKI INDUSTRIAL AREA",
  "PULASKI HIGHWAY",
  "PURNELL",
  "RADNOR-WINSTON",
  "Ramblewood",
  "REISTERSTOWN STATION",
  "REMSEN",
  "RESERVOIR HILL",
  "RIDGELY'S DELIGHT",
  "RIVERSIDE",
  "RIVERWOOD",
  "ROLAND PARK",
  "ROSEMONT",
  "ROSEMONT EAST",
  "SABINA-MATTHEW STAWHI",
  "SANDTOWN-WINCHESTER",
  "SETON HILL",
  "SHARP-LEADENHALL",
  "SHIPLEY HILL",
  "SOUTH CLIFTON PARK",
  "SOUTH FULTON",
  "SOUTH GOVANS",
  "SOUTH BALTIMORE",
  "SOUTHBROOK",
  "SOUTHWEST INDUSTRIAL AREA",
  "SPRING GARDEN INDUSTRIAL AREA",
  "STONEWOOD-PENTWOOD-WINSTON",
  "TEN HILLS",
  "TOWANDA-GRANTLEY",
  "TREMONT",
  "TRIANA",
  "TUSCANY-CANTERBURY",
  "UNION SQUARE",
  "UPPER FELLS POINT",
  "UPPER NORTHWOOD",
  "UPTON",
  "VIOLETVILLE",
  "VILLAGES OF HOMELAND",
  "WALTHerson",
  "WASHINGTON HILL",
  "WASHINGTON VILLAGE",
  "WAVERLY",
  "WEST ARLINGTON",
  "WEST FOREST PARK",
  "WESTGATE",
  "WILSON PARK",
  "WINCHESTER",
  "WINDSOR HILLS",
  "WISTERIA",
  "WOODBERRY",
  "YALE HEIGHTS",
];

export async function GET() {
  try {
    // Try distinct neighborhood values from DB first
    const rows = await db
      .select({ neighborhood: violations.neighborhood })
      .from(violations)
      .where(sql`neighborhood is not null and neighborhood <> ''`)
      .groupBy(violations.neighborhood)
      .limit(1000);

    const fromDb = rows
      .map((r) => r.neighborhood as unknown as string)
      .filter(Boolean);

    // union with static fallback
    const set = new Set<string>([...fromDb, ...STATIC_NEIGHBORHOODS]);
    const neighborhoods = Array.from(set).sort((a, b) => a.localeCompare(b));

    return NextResponse.json(
      { neighborhoods },
      { headers: { "cache-control": "no-store" } }
    );
  } catch {
    // If DB is unreachable, still return the static list
    const neighborhoods = [...STATIC_NEIGHBORHOODS].sort((a, b) =>
      a.localeCompare(b)
    );
    return NextResponse.json(
      { neighborhoods },
      { headers: { "cache-control": "no-store" } }
    );
  }
}
